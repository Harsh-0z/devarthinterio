<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <title>Admin Dashboard</title>
  <link rel="stylesheet" href="/assets/css/dashboard.css">
  <style>
    #imageList {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 1.5rem;
      padding: 1rem;
    }
    
    #imageGallery img {
      width: 100%;
      height: 300px; /* Fixed height for consistency */
      object-fit: cover; /* Ensures the image fills the container */
      border-radius: 10px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); /* Optional: Add shadow for better aesthetics */
    }
    
    #imageList div {
      display: flex;
      flex-direction: column; /* Stack image and button */
      align-items: center; /* Center align horizontally */
      justify-content: space-between; /* Space out items vertically */
    }
    
    
    canvas {
      width: 100% !important; /* Force full width */
      height: auto !important; /* Adjust height based on width */
      max-width: 100%; /* Prevent the canvas from exceeding container width */
    }
  
    /* Container for each chart with margin and padding */
    .chart-container {
      width: 100%;
      max-width: 600px; /* Limit the max-width to make it look good on larger screens */
      margin: 0 auto; /* Center the chart */
      padding: 20px;
    }
  
    /* Media Queries for better responsiveness on mobile devices */
    @media (max-width: 600px) {
      /* Adjust chart size for mobile screens */
      .chart-container {
        max-width: 100%;
      }
  
      canvas {
        height: 250px; /* Smaller height on mobile */
      }
    }
  
    /* Optional: Center the text and adjust margins */
    .content {
      padding: 10px;
    }
  
    /* Optional: Add some spacing between the sections */
    .section {
      margin-bottom: 30px;
    }
    /* Sidebar Styles */
    .sidebar {
      width: 250px;
      background-color: #1a202c;
      color: white;
      height: 100vh;
      position: fixed;
      top: 0;
      left: 0;
      display: flex;
      flex-direction: column;
      padding: 20px;
    }

    .sidebar h2 {
      font-size: 1.5rem;
      margin-bottom: 20px;
    }

    .sidebar a {
      color: white;
      text-decoration: none;
      margin-bottom: 10px;
      padding: 10px 15px;
      border-radius: 5px;
      display: block;
    }

    .sidebar a:hover {
      background-color: #4a5568;
    }

    .content {
      margin-left: 270px;
      padding: 20px;
    }

    .section {
      display: none;
    }

    .section.active {
      display: block;
    }

    .form-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px;
      border: 1px solid #ccc;
      margin-bottom: 10px;
      border-radius: 5px;
      background-color: #f9f9f9;
    }

    .form-item p {
      margin: 0;
    }

    .form-item button {
      background: #007bff;
      color: white;
      border: none;
      padding: 5px 10px;
      border-radius: 5px;
      cursor: pointer;
    }

    .form-item button:hover {
      background: #0056b3;
    }

    .form-item button.delete-btn {
      background: #dc3545;
    }

    .form-item button.delete-btn:hover {
      background: #a71d2a;
    }

    /* Modal for viewing form details */
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      display: none;
      justify-content: center;
      align-items: center;
    }

    .modal.active {
      display: flex;
    }

    .modal-content {
      background: white;
      padding: 20px;
      border-radius: 5px;
      width: 400px;
    }
  </style>
</head>
<body>
  <!-- Sidebar -->
  <div class="sidebar">
    <h2>Admin Dashboard</h2>
    <a href="#" data-section="image-management">Image Management</a>
    <a href="#" data-section="password-management">Change Password</a>
    <a href="#" data-section="form-responses">Form Responses</a>
    <a href="#" data-section="data-analytics">Data Analytics</a> <!-- Add this line -->
    <button id="logoutBtn" class="bg-red-500 w-full text-center">Logout</button>
  </div>
  

  <!-- Main Content -->
  <div class="content">
    <!-- Image Management Section -->
    <div id="image-management" class="section active">
      <h2 class="text-2xl font-semibold">
        Image Management for <span id="categoryName">Default</span>
      </h2>
      <form id="imageForm" enctype="multipart/form-data">
        <div class="form-group">
          <label for="category" class="block text-gray-700">Select Category:</label>
          <select id="category" name="category" class="w-full px-4 py-2 border rounded">
            <option value="trophies">Trophies</option>
            <option value="keychains">Keychains</option>
            <option value="pens">Pens</option>
            <option value="diary">Diaries</option>
            <option value="photoframe">Photo Frames</option>
            <option value="mugs">Mugs</option>
            <option value="nameplates">Name Plates</option>
            <option value="housenameplates">House Name Plates</option>
            <option value="memento">Mementos</option>
            <option value="bottle">Bottles</option>
            <option value="uv">UV DTF Stickers</option>
            <option value="neon">Neon Lights</option>
          </select>
        </div>
    
        <div class="form-group">
          <label for="images" class="block text-gray-700">Upload Images:</label>
          <input type="file" id="images" name="images" accept="image/*" multiple class="w-full px-4 py-2 border rounded">
        </div>
    
        <button type="submit" class="bg-green-500 text-white px-4 py-2 rounded">Upload</button>
      </form>
    
      <!-- Image List Container -->
      <div id="imageList" class="grid grid-cols-3 gap-4">
        <!-- Dynamically loaded images will appear here -->
      </div>
      
    
    <!-- Password Management Section -->
    <div id="password-management" class="section">
      <h2 class="text-2xl font-semibold">Change Password</h2>
      <form id="passwordForm">
        <div class="form-group">
          <label for="currentPassword" class="block text-gray-700">Current Password:</label>
          <input type="password" id="currentPassword" name="currentPassword" class="w-full px-4 py-2 border rounded" required>
        </div>

        <div class="form-group">
          <label for="newPassword" class="block text-gray-700">New Password:</label>
          <input type="password" id="newPassword" name="newPassword" class="w-full px-4 py-2 border rounded" required>
        </div>

        <div class="form-group">
          <label for="confirmPassword" class="block text-gray-700">Confirm New Password:</label>
          <input type="password" id="confirmPassword" name="confirmPassword" class="w-full px-4 py-2 border rounded" required>
        </div>

        <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded">Change Password</button>
      </form>
    </div>

    <!-- Form Responses Section -->
    <div id="form-responses" class="section">
      <h2 class="text-2xl font-semibold">Form Responses</h2>
      <div id="formList">
        <!-- Form responses will be dynamically loaded here -->
      </div>
    </div>

    <!-- Modal for viewing form details -->
    <div id="formDetailsModal" class="modal">
      <div class="modal-content">
        <h3 class="text-xl font-semibold">Form Details</h3>
        <p id="formDetailsContent"></p>
        <button id="closeModal" class="bg-red-500 text-white px-4 py-2 rounded">Close</button>
      </div>
    </div>
  </div>

  <!-- Data Analytics Section -->
<div id="data-analytics" class="section">
  <h2 class="text-2xl font-semibold">Data Analytics</h2>

  <!-- Today's Visits -->
  <div class="chart-container" style="border: 1px solid #ccc; border-radius: 8px; padding: 20px; margin-bottom: 20px;">
    <h3>Today's Visits</h3>
    <p>Total Visits Today: <span id="todayTotal">0</span></p>
    <canvas id="todayVisitsChart"></canvas>
  </div>

  <!-- This Week's Visits -->
  <div class="chart-container" style="border: 1px solid #ccc; border-radius: 8px; padding: 20px; margin-bottom: 20px;">
    <h3>This Week's Visits</h3>
    <p>Total Visits This Week: <span id="weekTotal">0</span></p>
    <canvas id="weekVisitsChart"></canvas>
  </div>

  <!-- This Month's Visits -->
  <div class="chart-container" style="border: 1px solid #ccc; border-radius: 8px; padding: 20px;">
    <h3>This Month's Visits</h3>
    <p>Total Visits This Month: <span id="monthTotal">0</span></p>
    <canvas id="monthVisitsChart"></canvas>
  </div>
</div>

  <script>
    document.getElementById('imageForm').addEventListener('submit', function(event) {
      event.preventDefault();
      const formData = new FormData(this);
  
      fetch('/admin/upload-images', {
          method: 'POST',
          body: formData,
      })
          .then(response => response.json())
          .then(data => {
              if (data.success) {
                  alert('Images uploaded successfully');
                  loadImages(); // Reload the gallery
              } else {
                  alert('Error uploading images');
              }
          })
          .catch(error => {
              console.error('Error uploading images:', error);
              alert('Something went wrong');
          });
  });
  

    // Function to fetch and display images for the selected category
    function loadImages() {
      const category = document.getElementById('category').value;
      document.getElementById('categoryName').innerText = category.charAt(0).toUpperCase() + category.slice(1);
    
      fetch(`/images/${category}`)
        .then(response => response.json())
        .then(data => {
          const imageList = document.getElementById('imageList');
          imageList.innerHTML = ''; // Clear existing images
    
          if (data.images && data.images.length > 0) {
            data.images.forEach(image => {
              const imgElement = document.createElement('div');
              imgElement.classList.add('product');
              imgElement.innerHTML = `
                <div class="product-img">
                  <img src="${image.path}" alt="${category} Image">
                </div>
                <button class="delete-btn bg-red-500 text-white px-4 py-2 mt-2 rounded" data-id="${image._id}">Delete</button>
              `;
              imageList.appendChild(imgElement);
            });
    
            // Add event listener to delete buttons
            document.querySelectorAll('.delete-btn').forEach(button => {
              button.addEventListener('click', function () {
                deleteImage(this.getAttribute('data-id'), category);
              });
            });
          } else {
            imageList.innerHTML = '<p>No images found for this category.</p>';
          }
        })
        .catch(error => {
          console.error('Error loading images:', error);
        });
    }
    
    
    
    

// Function to delete an image
function deleteImage(imageId, category) {
  fetch(`/admin/images/${category}/${imageId}`, { method: 'DELETE' })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        alert('Image deleted successfully');
        loadImages(); // Reload images after deletion
      } else {
        alert('Error deleting image');
      }
    })
    .catch(error => {
      console.error('Error:', error);
      alert('Something went wrong');
    });
}



// Load new images when the category is changed
document.getElementById('category').addEventListener('change', function() {
  loadImages();
});

    function deleteImage(imageId, category) {
      fetch(`/admin/images/${category}/${imageId}`, { method: 'DELETE' })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            alert('Image deleted successfully');
            loadImages(); // Reload images
          } else {
            alert('Error deleting image');
          }
        })
        .catch(error => {
          console.error('Error:', error);
          alert('Something went wrong');
        });
    }
    
    document.getElementById('category').addEventListener('change', function() {
      loadImages();
    });
    
    
    
    // Sidebar Navigation
    const sections = document.querySelectorAll('.section');
    const sidebarLinks = document.querySelectorAll('.sidebar a');

    sidebarLinks.forEach(link => {
      link.addEventListener('click', event => {
        event.preventDefault();
        const sectionId = event.target.dataset.section;
    
        sections.forEach(section => {
          section.classList.remove('active');
        });
    
        const activeSection = document.getElementById(sectionId);
        activeSection.classList.add('active');
    
        // Load form responses when navigating to the form-responses section
        if (sectionId === 'form-responses') {
          loadFormResponses();
        }
      });
    });
    
    // Ensure form responses are loaded initially if the section is active
    if (document.getElementById('form-responses').classList.contains('active')) {
      loadFormResponses();
    }
    

    // Logout Functionality
    document.getElementById('logoutBtn').addEventListener('click', function () {
      fetch('/admin/logout', { method: 'GET' })
        .then(() => window.location.href = '/admin/login')
        .catch(err => alert('Error logging out'));
    });

    // Load Form Responses
    // Load Form Responses
async function loadFormResponses() {
  const formList = document.getElementById('formList');
  formList.innerHTML = '<p>Loading form responses...</p>'; // Loading indicator

  try {
    const response = await fetch('/admin/form-responses');
    if (!response.ok) {
      throw new Error(`Failed to fetch form responses: ${response.statusText}`);
    }

    const data = await response.json();
    formList.innerHTML = ''; // Clear existing items after loading

    if (data.length === 0) {
      formList.innerHTML = '<p>No form responses found.</p>';
      return;
    }

    data.forEach((form) => {
      const formItem = document.createElement('div');
      formItem.classList.add('form-item');
      formItem.innerHTML = `
        <div>
          <p><strong>${form.fullName}</strong> (${new Date(form.submittedAt).toLocaleString()})</p>
          <p><em>${form.category}</em></p>
        </div>
        <div>
          <button class="view-btn" onclick="viewFormDetails('${form._id}')">View</button>
          <button class="delete-btn" onclick="deleteFormResponse('${form._id}')">Delete</button>
        </div>
      `;
      formList.appendChild(formItem);
    });
  } catch (error) {
    console.error('Error loading form responses:', error);
    formList.innerHTML = `<p class="error">Error loading form responses: ${error.message}</p>`;
  }
}

// View Form Details
async function viewFormDetails(id) {
  const modal = document.getElementById('formDetailsModal');
  const content = document.getElementById('formDetailsContent');
  content.innerHTML = '<p>Loading details...</p>';
  modal.classList.add('active');

  try {
    const response = await fetch(`/admin/form-responses/${id}`);
    if (!response.ok) {
      throw new Error(`Failed to fetch form details: ${response.statusText}`);
    }

    const data = await response.json();
    content.innerHTML = `
      <p><strong>Name:</strong> ${data.fullName}</p>
      <p><strong>Email:</strong> ${data.email}</p>
      <p><strong>Phone:</strong> ${data.phoneNumber}</p>
      <p><strong>Address:</strong> 
        ${data.address.street}, 
        ${data.address.city}, 
        ${data.address.region}, 
        ${data.address.postalCode}
      </p>
      <p><strong>Category:</strong> ${data.category}</p>
      <p><strong>Submitted At:</strong> ${new Date(data.submittedAt).toLocaleString()}</p>
      <div><strong>Images:</strong></div>
      <div id="imageGallery" style="max-height: 300px; overflow-y: auto; border: 1px solid #ddd; padding: 10px;">
        ${
          data.photos.length > 0
            ? data.photos
                .map(
                  (photo) => `
                  <img 
                    src="${photo}" 
                    onclick="zoomImage('${photo}')"
                    alt="Photo" 
                    style="max-width: 100%; cursor: pointer; margin-bottom: 10px;">
                `
                )
                .join('')
            : '<p>No images available.</p>'
        }
      </div>
    `;
  } catch (error) {
    console.error('Error loading form details:', error);
    content.innerHTML = `<p class="error">Error loading form details: ${error.message}</p>`;
  }
}
document.getElementById('closeModal').addEventListener('click', () => {
  document.getElementById('formDetailsModal').classList.remove('active'); // Hides the modal
});

// Delete Form Response
async function deleteFormResponse(id) {
  if (!confirm('Are you sure you want to delete this form response?')) return;

  try {
    const response = await fetch(`/admin/form-responses/${id}`, { method: 'DELETE' });
    if (!response.ok) {
      throw new Error(`Failed to delete form response: ${response.statusText}`);
    }

    alert('Form response deleted successfully');
    loadFormResponses(); // Refresh the list
  } catch (error) {
    console.error('Error deleting form response:', error);
    alert(`Error deleting form response: ${error.message}`);
  }
}

// Zoom Image Functionality
function zoomImage(url) {
  const zoomModal = document.createElement('div');
  zoomModal.style.position = 'fixed';
  zoomModal.style.top = '0';
  zoomModal.style.left = '0';
  zoomModal.style.width = '100%';
  zoomModal.style.height = '100%';
  zoomModal.style.backgroundColor = 'rgba(0, 0, 0, 0.8)';
  zoomModal.style.display = 'flex';
  zoomModal.style.justifyContent = 'center';
  zoomModal.style.alignItems = 'center';
  zoomModal.style.zIndex = '1000';

  const zoomedImage = document.createElement('img');
  zoomedImage.src = url;
  zoomedImage.style.maxWidth = '90%';
  zoomedImage.style.maxHeight = '90%';
  zoomedImage.style.border = '2px solid #fff';
  zoomedImage.style.borderRadius = '10px';

  const closeButton = document.createElement('button');
  closeButton.textContent = 'Close';
  closeButton.style.position = 'absolute';
  closeButton.style.top = '20px';
  closeButton.style.right = '20px';
  closeButton.style.backgroundColor = '#ff4d4d';
  closeButton.style.color = '#fff';
  closeButton.style.border = 'none';
  closeButton.style.padding = '10px 20px';
  closeButton.style.cursor = 'pointer';
  closeButton.style.fontSize = '16px';

  closeButton.onclick = () => {
    document.body.removeChild(zoomModal);
  };

  zoomModal.appendChild(zoomedImage);
  zoomModal.appendChild(closeButton);
  document.body.appendChild(zoomModal);
}

// Load Analytics Data
async function fetchInitialAnalyticsData() {
  try {
    const response = await fetch('/admin/analytics-data');
    if (!response.ok) {
      throw new Error(`Failed to fetch initial analytics data: ${response.statusText}`);
    }
    return await response.json();
  } catch (error) {
    console.error('Error fetching initial analytics data:', error);
    return null;
  }
}

let todayVisitsChart = null;
let weekVisitsChart = null;
let monthVisitsChart = null;

// Function to log a visit when the page loads
async function logVisit() {
  try {
    await fetch('/log-visit', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
    });
  } catch (error) {
    console.error('Error logging visit:', error);
  }
}

// Function to load and render analytics data
async function loadAnalyticsData() {
  try {
    const response = await fetch('/admin/analytics-data');
    const data = await response.json();

    // Update totals
    document.getElementById('todayTotal').textContent = data.todayVisits;
    document.getElementById('weekTotal').textContent = data.weeklyVisits.reduce((a, b) => a + b, 0);
    document.getElementById('monthTotal').textContent = data.monthlyVisits.reduce((a, b) => a + b, 0);

    // Render Today's Visits Graph
    if (todayVisitsChart) todayVisitsChart.destroy(); // Destroy the existing chart
    todayVisitsChart = new Chart(document.getElementById('todayVisitsChart').getContext('2d'), {
      type: 'bar',
      data: {
        labels: ['Today'],
        datasets: [
          {
            label: 'Visits',
            data: [data.todayVisits],
            backgroundColor: 'rgba(75, 192, 192, 0.2)',
            borderColor: 'rgba(75, 192, 192, 1)',
            borderWidth: 1,
          },
        ],
      },
      options: { responsive: true },
    });

    // Render This Week's Visits Graph
    if (weekVisitsChart) weekVisitsChart.destroy(); // Destroy the existing chart
    weekVisitsChart = new Chart(document.getElementById('weekVisitsChart').getContext('2d'), {
      type: 'line',
      data: {
        labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
        datasets: [
          {
            label: 'Visits',
            data: data.weeklyVisits,
            backgroundColor: 'rgba(153, 102, 255, 0.2)',
            borderColor: 'rgba(153, 102, 255, 1)',
            borderWidth: 1,
            fill: true,
          },
        ],
      },
      options: { responsive: true },
    });

    // Render This Month's Visits Graph
    if (monthVisitsChart) monthVisitsChart.destroy(); // Destroy the existing chart
    monthVisitsChart = new Chart(document.getElementById('monthVisitsChart').getContext('2d'), {
      type: 'line',
      data: {
        labels: Array.from({ length: 30 }, (_, i) => `Day ${i + 1}`),
        datasets: [
          {
            label: 'Visits',
            data: data.monthlyVisits,
            backgroundColor: 'rgba(255, 159, 64, 0.2)',
            borderColor: 'rgba(255, 159, 64, 1)',
            borderWidth: 1,
            fill: true,
          },
        ],
      },
      options: { responsive: true },
    });
  } catch (error) {
    console.error('Error loading analytics data:', error);
  }
}

// Initial load on window load
window.onload = async () => {
  await logVisit(); // Log visit once when the page loads
  await loadAnalyticsData(); // Load initial analytics data
  setInterval(() => loadAnalyticsData(), 5000); // Update analytics data every 5 seconds

  // Initialize the image gallery for the default category
  loadImages(); // Call loadImages to fetch and display images
};






  </script>
</body>
</html>


